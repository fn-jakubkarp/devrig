---
- name: Personal Ubuntu/Debian Setup with Chezmoi
  hosts: localhost
  become: yes
  vars:
    username: "{{ ansible_env.USER }}"
    chezmoi_repo: "https://github.com/fn-jakubkarp/dotfiles"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: yes
        
    - name: Install common utilities
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - git
        - curl
        - wget
        - htop
        - tmux
        - unzip
        - python3-pip
        
    - name: Install Go (required for chezmoi)
      apt:
        name: golang
        state: present

    - name: Install Chezmoi
      shell: |
        sh -c "$(curl -fsLS get.chezmoi.io)"
      args:
        creates: /usr/local/bin/chezmoi
      become: no

    - name: Initialize Chezmoi with your dotfiles repository
      shell: |
        chezmoi init {{ chezmoi_repo }}
      args:
        creates: "~/.local/share/chezmoi"
      become: no
      when: chezmoi_repo != "YOUR_CHEZMOI_REPO_URL"

    - name: Apply Chezmoi configuration
      shell: chezmoi apply
      become: no
      when: chezmoi_repo != "YOUR_CHEZMOI_REPO_URL"

    - name: Create common directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ username }}"
        group: "{{ username }}"
      loop:
        - ~/Documents/projects
        - ~/Documents/scripts
        - ~/Downloads/temp
        
    - name: Install SSH server
      apt:
        name: openssh-server
        state: present
        
    - name: Enable SSH service
      service:
        name: ssh
        state: started
        enabled: yes